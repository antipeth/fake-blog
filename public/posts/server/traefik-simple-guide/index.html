<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ATP</title>
     <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js" integrity="sha256-WCzAhd2P6gRJF9Hv3oOOd+hFJi/QJbv+Azn4CGB8gfY=" crossorigin="anonymous"></script>
     <script src="/js/index.js"></script>
     <script src="/js/prompt.js"></script>
     <script src="/js/keyboard.js"></script>
     <script src="/js/tab.js"></script>
     <script src="/js/commands.js"></script>
     <script src="/js/config.js"></script><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/css/page.css"></head>
<body onkeydown='exec(event)'>
  <header>
      <h1>ATP</h1>
  </header>
  <main>
    <div class="files" id="files" tabindex="0">
<ul><li class="file">
    <span><a href='https://blog.0pt.icu/readme/'
      tabindex="-2">ï’¥  README</a></span>
  </li><li class="file">
    <span><a href='https://blog.0pt.icu/rss/'
      tabindex="-3">ï’¥  RSS</a></span>
  </li><li class="folder"><span>
      
      <a href='https://blog.0pt.icu/posts/'
        tabindex="-4">ï“  Posts
      </a>
    </span>

    <ul>
      
        
        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/think/'
    tabindex="-5">ï“  Think
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/2024/'
        tabindex="-6">ï’¥  2024</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/unhappy-newyear/'
        tabindex="-7">ï’¥  ç¥ä½ æ˜¥èŠ‚ä¸å¿«ä¹</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/1st-anniversary-of-listening-to-tayu-lo/'
        tabindex="-8">ï’¥  çºªå¿µå¬ç½—å¤§ä½‘ä¸€å‘¨å¹´</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/music-history/'
        tabindex="-9">ï’¥  è®°æˆ‘çš„å¬æ­Œå†ç¨‹</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/my-first-post/'
        tabindex="-10">ï’¥  My first post</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/homelab/'
    tabindex="-11">ï“  homelab
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/homelab/nixos-nas/'
        tabindex="-12">ï’¥  My NixOS NASğŸ§Š</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/linux-trip/'
    tabindex="-13">ï“  Linux Trip
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/7/'
        tabindex="-14">ï’¥  ç¬¬ä¸ƒå›ï¼Œæ¢FreeBSDè·¯é€”è¿œï¼Œåå·è†æ£˜å‹‡å‰è¡Œ</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/6/'
        tabindex="-15">ï’¥  ç¬¬å…­å›ï¼Œå¼ƒLinuxæŠ•FreeBSDï¼Œç¨³å¦‚ç£çŸ³è·¯æ›´å®½</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/5/'
        tabindex="-16">ï’¥  ç¬¬äº”å›ï¼Œæ¸è§‰Archæ— åŠ›æŒï¼Œè½¬æŠ•NixOSè·æ–°ç”Ÿ</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/4/'
        tabindex="-17">ï’¥  ç¬¬å››å›ï¼ŒèˆKDEæŠ±Hyprlandï¼Œæ–°å¢ƒç•Œè¿½æ±‚æ›´æ·»</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/3/'
        tabindex="-18">ï’¥  ç¬¬ä¸‰å›ï¼Œæ¢å¹½å¯»ç§˜APPSæ–°ï¼Œè§£CONFIGå¥‡è¶£å…¥çœ¼å‰</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/2/'
        tabindex="-19">ï’¥  ç¬¬äºŒå›ï¼Œåˆå…¥KDEè™šç•Œé—´ï¼Œå®‰è£…APPSè€€ç›®å…‰</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/1/'
        tabindex="-20">ï’¥  ç¬¬ä¸€å›ï¼Œå¼ƒwindowæ¸å…¥è½»ç›ˆå¢ƒï¼Œè£…Archèµ°å…¥å‘æ·±åº•</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/k3s/'
    tabindex="-21">ï“  K3S
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/k3s/develop-rancher/'
        tabindex="-22">ï’¥  k3séƒ¨ç½²rancher</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/k3s/kubevirt-manager/'
        tabindex="-23">ï’¥  k3séƒ¨ç½²kubevirt-manager</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/pve/'
    tabindex="-24">ï“  PVE
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/pve/pve-hackintosh/'
        tabindex="-25">ï’¥  x79ä¸Špveé»‘è‹¹æœ</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/pve/build-pve/'
        tabindex="-26">ï’¥  x79æ­å»ºpveå¹¶å¼€å¯ç¡¬ä»¶ç›´é€š</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/server/'
    tabindex="-27">ï“  server
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a class="selected"href='https://blog.0pt.icu/posts/server/traefik-simple-guide/'
        tabindex="-28">ï’¥  Docker/NixOSä½¿ç”¨traefikå®ç°ç®€å•åä»£</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/caddy-simple-guide/'
        tabindex="-29">ï’¥  Debian/NixOSä½¿ç”¨caddyå®ç°ç®€å•åä»£</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/use-tebi-build-nixos-cache-server/'
        tabindex="-30">ï’¥  ä½¿ç”¨tebiä½œä¸ºs3,æ­å»ºnixç¼“å­˜æœåŠ¡å™¨</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/cloudfront-cdn-acme/'
        tabindex="-31">ï’¥  cloudfronté…ç½®å°é¸¡cdnå¹¶ä½¿ç”¨acme.shè‡ªåŠ¨è·å–è¯ä¹¦</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/build-terraria-tshock/'
        tabindex="-32">ï’¥  æ­å»ºæ³°æ‹‰ç‘äºšTshockæœåŠ¡å™¨(å¼ºåˆ¶å¼€è’)</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/build-hugo/'
        tabindex="-33">ï’¥  åŸºäºArch Linuxæ­å»ºhugoåšå®¢</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/hackintosh/'
    tabindex="-34">ï“  Hackintosh
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/hackintosh/x79/'
        tabindex="-35">ï’¥  è®°å½•ä¸€æ¬¡æ‚ç‰Œx79é»‘è‹¹æœ</a>
    </span>
  </li></ul>
</li>

        
    </ul>
  </li><li class="folder"><span>
      
      <a href='https://blog.0pt.icu/about/'
        tabindex="-36">ï“  ABOUT
      </a>
    </span>

    <ul>
      <li class="file">
        <span>â””â”€â”€
          <a href='https://blog.0pt.icu/about/about2/'
            tabindex="-37">ï’¥  ABOUT2</a>
        </span>
      </li><li class="file">
        <span>â””â”€â”€
          <a href='https://blog.0pt.icu/about/about1/'
            tabindex="-38">ï’¥  ABOUT1</a>
        </span>
      </li>
        
    </ul>
  </li><li class="folder"><span>
      
      <a href='https://blog.0pt.icu/links/'
        tabindex="-39">ï“  LINKS
      </a>
    </span>

    <ul>
      <li class="file">
        <span>â””â”€â”€
          <a href='https://blog.0pt.icu/links/link/'
            tabindex="-40">ï’¥  LINKS</a>
        </span>
      </li>
        
    </ul>
  </li>
</ul>
</div>
    <div class="viewer page" id="viewer" tabindex="0">
      <div class="tab">
<ul id="tabs">
</ul>


</div>
      <div class="content" id="content"><h1 id="docker-nixosshi-yong-traefikshi-xian-jian-dan-fan-dai">Docker/NixOSä½¿ç”¨traefikå®ç°ç®€å•åä»£</h1>
<p>2024-12-20
å‚è€ƒ</p>
<ol>
<li>https://doc.traefik.io/traefik/</li>
<li>https://github.com/anandslab/docker-traefik</li>
<li>https://blog.eleven-labs.com/en/using-traefik-as-a-reverse-proxy/</li>
<li>https://github.com/korridor/reverse-proxy-docker-traefik</li>
<li>https://wiki.nixos.org/wiki/Traefik</li>
<li>https://blog.outv.im/2022/traefik/#traefik-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F</li>
</ol>
<h2 id="docker">Docker</h2>
<h3 id="httpfan-dai">httpåä»£</h3>
<p>å…ˆæ˜¯traefik</p>
<p>åŸºæœ¬ç»“æ„æ˜¯</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>å…¥å£(entrypoints)-&gt;è·¯ç”±(routers)-&gt;æœåŠ¡(services)
</span></code></pre>
<p>å…ˆè§£é‡Šå‡ æ¡é…ç½®
è¿™ä¸ªæ˜¯dockerå¯åŠ¨traefikçš„åŸºæœ¬é…ç½®,ä½¿ç”¨<code>command</code>ä¼ è¿›å»</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    command:
</span><span>      - --api.insecure=true # å¼€å¯8080ç«¯å£çš„webuiç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°traefikå¯è§†åŒ–é¢æ¿
</span><span>      - --providers.docker=true # å¼€å¯ç›‘æ§dockerå®¹å™¨
</span><span>      - --providers.docker.exposedbydefault=false # é»˜è®¤ä¸è‡ªåŠ¨æš´éœ²å®¹å™¨,éšè—æ­¤å®¹å™¨
</span></code></pre>
<p>æ¥ä¸‹æ¥æ˜¯å…¥å£<code>entrypoints</code>,ä¹Ÿä½¿ç”¨<code>command</code>ä¼ è¿›å»,æ ¼å¼å¦‚ä¸‹</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    command:
</span><span>      - --entrypoints.&lt;entrypoints-name-1&gt;.address=:80
</span><span>      - --entrypoints.&lt;entrypoints-name-2&gt;.address=:443
</span></code></pre>
<p>å®šä¹‰ç›‘å¬çš„å…¥å£ï¼Œå¯¹äºåä»£æ¥è¯´ï¼Œåªéœ€è¦ç›‘å¬<code>:80</code>å’Œ<code>:443</code>ï¼Œä¹Ÿå°±æ˜¯<code>http</code>å’Œ<code>https</code>çš„æµé‡ã€‚å°†&lt;entrypoints-name-1/2&gt;è‡ªè¡Œæ›¿æ¢æˆä½ æƒ³è¦çš„åå­—ï¼Œå¦‚</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    command:
</span><span>      - --entrypoints.http.address=:80
</span><span>      - --entrypoints.https.address=:443
</span></code></pre>
<p>æˆ–è€…</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    command:
</span><span>      - --entrypoints.web.address=:80
</span><span>      - --entrypoints.websecure.address=:443
</span></code></pre>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆå¾—åˆ°ä¸€ä¸ª<code>traefik</code>å®¹å™¨çš„ç¼–æ’æ–‡ä»¶</p>
<p>dockerçš„<code>traefik</code>ç½‘ç»œéœ€è¦æå‰åˆ›å»ºå¥½</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">docker</span><span> network create</span><span style="color:#ffcc66;"> --driver</span><span> bridge traefik
</span></code></pre>
<p>traefikçš„docker-compose.yml</p>
<pre data-lang="yaml" style="background-color:#212733;color:#ccc9c2;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#73d0ff;">version</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&#39;3&#39;
</span><span>
</span><span style="color:#73d0ff;">services</span><span style="color:#ccc9c2cc;">:
</span><span>  </span><span style="color:#73d0ff;">reverse-proxy</span><span style="color:#ccc9c2cc;">:
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># The official v3 Traefik docker image
</span><span>    </span><span style="color:#73d0ff;">image</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">traefik:v3.2
</span><span>    </span><span style="font-style:italic;color:#5c6773;"># Enables the web UI and tells Traefik to listen to docker
</span><span>    </span><span style="color:#73d0ff;">command</span><span style="color:#ccc9c2cc;">:
</span><span>      - </span><span style="color:#bae67e;">--api.insecure=true
</span><span>      - </span><span style="color:#bae67e;">--providers.docker=true
</span><span>      - </span><span style="color:#bae67e;">--providers.docker.exposedbydefault=false </span><span style="font-style:italic;color:#5c6773;"># é»˜è®¤ä¸è‡ªåŠ¨æš´éœ²å®¹å™¨,éšè—æ­¤å®¹å™¨
</span><span>      - </span><span style="color:#bae67e;">--entrypoints.web.address=:80            </span><span style="font-style:italic;color:#5c6773;"># HTTP å…¥å£ç‚¹
</span><span>      - </span><span style="color:#bae67e;">--entrypoints.websecure.address=:443           </span><span style="font-style:italic;color:#5c6773;"># HTTPS å…¥å£ç‚¹
</span><span>    </span><span style="color:#73d0ff;">ports</span><span style="color:#ccc9c2cc;">:
</span><span>      </span><span style="font-style:italic;color:#5c6773;"># The HTTP port
</span><span>      - </span><span style="color:#bae67e;">&quot;80:80&quot;
</span><span>      - </span><span style="color:#bae67e;">&quot;443:443&quot;
</span><span>      </span><span style="font-style:italic;color:#5c6773;"># The Web UI (enabled by --api.insecure=true)
</span><span>      - </span><span style="color:#bae67e;">&quot;8080:8080&quot;
</span><span>    </span><span style="color:#73d0ff;">volumes</span><span style="color:#ccc9c2cc;">:
</span><span>      </span><span style="font-style:italic;color:#5c6773;"># So that Traefik can listen to the Docker events
</span><span>      - </span><span style="color:#bae67e;">/var/run/docker.sock:/var/run/docker.sock
</span><span>    </span><span style="color:#73d0ff;">networks</span><span style="color:#ccc9c2cc;">:
</span><span>      - </span><span style="color:#bae67e;">traefik
</span><span style="color:#73d0ff;">networks</span><span style="color:#ccc9c2cc;">:
</span><span>  </span><span style="color:#73d0ff;">traefik</span><span style="color:#ccc9c2cc;">:
</span><span>    </span><span style="color:#73d0ff;">external</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffcc66;">true
</span></code></pre>
<p>ä¸‹é¢å¯åŠ¨ç¤ºä¾‹syncthing
æ¥ä¸‹æ¥ï¼Œåœ¨éœ€è¦å¯åŠ¨çš„å®¹å™¨,ä½¿ç”¨labelså°†éœ€è¦çš„å‚æ•°ä¼ å…¥
é¦–å…ˆï¼Œéœ€è¦å¯ç”¨traefik</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    labels:
</span><span>      - &quot;traefik.enable=true&quot;
</span></code></pre>
<p>ç„¶åï¼Œå®šä¹‰è·¯ç”±(routers)</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    labels:
</span><span>      - &quot;traefik.http.routers.&lt;routers-name-1&gt;.xxxxxxx&quot;
</span><span>      - &quot;traefik.tcp.routers.&lt;routers-name-2&gt;.xxxXXXX&quot;
</span></code></pre>
<p>æœ‰ä¸åŒåè®®ï¼Œå› ä¸ºæˆ‘åªåä»£ç½‘é¡µç•Œé¢ï¼Œä»…ä½¿ç”¨<code>http</code>åè®®å³å¯
å°†&lt;routers-name-1/2&gt;æ›¿æ¢ä¸ºä½ æƒ³è¦çš„è·¯ç”±åå­—ï¼Œæ¯”å¦‚è¿™é‡Œç›´æ¥ä»¥<code>syncthing</code>å‘½å
ä¸‹é¢æ˜¯httpè¯¦ç»†é…ç½®</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    labels:
</span><span>      - &quot;traefik.http.routers.syncthing.rule=Host(`sync.example.com`)&quot;
</span><span>      - &quot;traefik.http.routers.syncthing.entrypoints=web&quot; # è®¾ç½®å…¥å£ä¸ºweb,ä¹Ÿå°±æ˜¯80
</span></code></pre>
<p>rule=Host(<code>sync.example.com</code>)åŒ¹é…åŸŸå
entrypoints=webåŒ¹é…åˆšæ‰å®šä¹‰çš„ç›‘å¬çš„å…¥å£,è¿™é‡Œå…ˆä½¿ç”¨http,æ‰€ä»¥ä½¿ç”¨web,ç›‘å¬:80ç«¯å£
æœ€åï¼Œå®šä¹‰æœåŠ¡(services),ç”±äºtraefikè‡ªåŠ¨ç›‘æ§å®¹å™¨ï¼Œä¼šè‡ªåŠ¨æŠŠå®¹å™¨ä½œä¸ºæœåŠ¡ä¸è·¯ç”±å…³è”èµ·æ¥ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸éœ€è¦é…ç½®ï¼Œé™¤éå®¹å™¨æš´éœ²äº†å¤šä¸ªç«¯å£
å½“å®¹å™¨åªæœ‰ä¸€ä¸ªç«¯å£çš„æ—¶å€™ï¼Œtraefiké»˜è®¤æŠŠæµé‡ä¼ ç»™è¿™ä¸ªç«¯å£,ä¸éœ€è¦é¢å¤–æŒ‡å®šç«¯å£
ä½†å®¹å™¨æœ‰å¤šä¸ªç«¯å£æ˜ å°„æ—¶ï¼Œtraefikä¸çŸ¥é“è¦æŠŠæµé‡ä¼ ç»™å“ªä¸€ä¸ªç«¯å£,æ‰€ä»¥éœ€è¦é¢å¤–é…ç½®æ¥æŒ‡å®šä¸€ä¸ªç«¯å£</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    labels:
</span><span>      - &quot;traefik.http.services.&lt;service-name&gt;.loadbalancer.server.port=8384&quot; # å¦‚æœæš´éœ²äº†å¤šä¸ªç«¯å£ï¼Œéœ€è¦æŒ‡å®šç«¯å£
</span></code></pre>
<p><service-name>æ›¿æ¢ä¸ºå®¹å™¨åå­—ï¼Œ<service-name>ä¸<routers-name>å¯ä»¥é‡å
è®°å¾—æ·»åŠ syncthingå®¹å™¨ä¸traefikå®¹å™¨åŒå±ä¸€ä¸ªç½‘ç»œï¼Œä¹Ÿå°±æ˜¯<code>traefik</code>è¿™ä¸ªç½‘ç»œä¹‹ä¸­ã€‚</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>version: &#39;3&#39;
</span><span>services:
</span><span>  syncthing:
</span><span>    image: syncthing/syncthing
</span><span>    container_name: syncthing
</span><span>    restart: unless-stopped
</span><span>    ulimits:
</span><span>      nproc: 65535
</span><span>      nofile:
</span><span>        soft: 65535
</span><span>        hard: 65535
</span><span>    volumes:
</span><span>      - /var/syncthing:/var/syncthing
</span><span>    environment:
</span><span>      - PUID=1000
</span><span>      - PGID=1000
</span><span>    ports:
</span><span>      - 8384:8384 # Web UI
</span><span>      - 22000:22000/tcp # TCP file transfers
</span><span>      - 22000:22000/udp # QUIC file transfers
</span><span>      - 21027:21027/udp # Receive local discovery broadcasts
</span><span>    labels:
</span><span>      - &quot;traefik.enable=true&quot; # å¯åŠ¨traefik
</span><span>      - &quot;traefik.http.routers.syncthing.rule=Host(`sync.example.com`)&quot; # åŒ¹é…åŸŸå
</span><span>      - &quot;traefik.http.routers.syncthing.entrypoints=web&quot; # è®¾ç½®å…¥å£ä¸ºweb,ä¹Ÿå°±æ˜¯80
</span><span>      - &quot;traefik.http.services.syncthing.loadbalancer.server.port=8384&quot; # å¦‚æœæš´éœ²äº†å¤šä¸ªç«¯å£ï¼Œéœ€è¦æŒ‡å®šç«¯å£
</span><span>      # ä¸‹é¢ä¸éœ€è¦ï¼Œç•™ç€ä»…ä¾›å‚è€ƒ
</span><span>      # - &quot;traefik.http.services.syncthing.loadbalancer.server.scheme=http&quot; # æ˜ç¡®æŒ‡å®š HTTP
</span><span>      # - &quot;traefik.docker.network=traefik&quot; # æŒ‡å®šdockerå®¹å™¨ç½‘ç»œ
</span><span>    networks:
</span><span>      - traefik
</span><span>networks:
</span><span>  traefik:
</span><span>    external: true
</span><span>
</span></code></pre>
<h1 id="tian-jia-tlszheng-shu">æ·»åŠ tlsè¯ä¹¦</h1>
<p>traefikéƒ¨åˆ†
åœ¨ä¿ç•™åˆšæ‰çš„åŸºç¡€ä¸Š
åœ¨<code>command</code>é‡Œé¢æ·»åŠ </p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>      - &quot;--certificatesresolvers.&lt;resolver-name&gt;.acme.tlschallenge=true&quot; # å¼€å¯è¯ä¹¦ç”³è¯·
</span><span>      - &quot;--certificatesresolvers.&lt;resolver-name&gt;.acme.email=yourmail@domain.com&quot; # ä½ çš„é‚®ç®±
</span><span>      - &quot;--certificatesresolvers.&lt;resolver-name&gt;.acme.storage=/letsencrypt/acme.json&quot; # è‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦é…ç½®å­˜åœ¨è¿™ä¸ªåœ°æ–¹
</span></code></pre>
<p>å°†<resolver-name>æ›¿æ¢ä¸ºä½ æƒ³è¦çš„åå­—ï¼Œè¿™é‡Œæ›¿æ¢ä¸º<code>myresolver</code>
æ³¨æ„ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªå‚¨å­˜å·æ¥å­˜æ”¾è¯ä¹¦é…ç½®ï¼Œä»¥åŠå¯ä»¥æŠŠhttpå…³æ‰ï¼ŒåŠdockerå…³é—­:80ç«¯å£,å–æ¶ˆ<code>entrypoints</code>çš„webè®¾ç½®
ç¤ºä¾‹å¦‚ä¸‹</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>version: &#39;3&#39;
</span><span>
</span><span>services:
</span><span>  reverse-proxy:
</span><span>    # The official v3 Traefik docker image
</span><span>    image: traefik:v3.2
</span><span>    # Enables the web UI and tells Traefik to listen to docker
</span><span>    command:
</span><span>      - &quot;--api.insecure=true&quot;
</span><span>      - &quot;--providers.docker=true&quot;
</span><span>      - &quot;--providers.docker.exposedbydefault=false&quot; # é»˜è®¤ä¸è‡ªåŠ¨æš´éœ²å®¹å™¨,éšè—æ­¤å®¹å™¨
</span><span>      - &quot;--entrypoints.websecure.address=:443&quot;           # HTTPS å…¥å£ç‚¹
</span><span>      - &quot;--certificatesresolvers.myresolver.acme.tlschallenge=true&quot; # å¼€å¯è¯ä¹¦ç”³è¯·
</span><span>      - &quot;--certificatesresolvers.myresolver.acme.email=your@mail.com&quot; # ä½ çš„é‚®ç®±
</span><span>      - &quot;--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json&quot; # è‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦é…ç½®å­˜åœ¨è¿™ä¸ªåœ°æ–¹
</span><span>    ports:
</span><span>      - &quot;443:443&quot;
</span><span>      # The Web UI (enabled by --api.insecure=true)
</span><span>      - &quot;8080:8080&quot;
</span><span>    volumes:
</span><span>      # So that Traefik can listen to the Docker events
</span><span>      - /var/run/docker.sock:/var/run/docker.sock
</span><span>      - /root/letsencrypt:/letsencrypt # å‚¨å­˜è¯ä¹¦é…ç½®
</span><span>    networks:
</span><span>      - traefik
</span><span>    # - ä¸‹é¢æ˜¯æŒ‡å®šé»˜è®¤ç”³è¯·çš„è¯ä¹¦ï¼Œä¸€èˆ¬æ¥è¯´ä¸éœ€è¦è¿™äº›é…ç½®ï¼Œtraefikä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ç”³è¯·tlsè¯ä¹¦
</span><span>      # labels:
</span><span>      # - &quot;traefik.tls.stores.default.defaultgeneratedcert.resolver=myresolver&quot; # æŒ‡å®šé»˜è®¤ç”³è¯·çš„resolver
</span><span>      # - &quot;traefik.tls.stores.default.defaultgeneratedcert.domain.main=example.org&quot; # æŒ‡å®šä¸»åŸŸå
</span><span>      # - &quot;traefik.tls.stores.default.defaultgeneratedcert.domain.sans=foo.example.org, bar.example.org&quot;
</span><span>networks:
</span><span>  traefik:
</span><span>    external: true
</span></code></pre>
<p>ç„¶åæ˜¯syncthing
åœ¨è·¯ç”±é…ç½®æŠŠ<code>entrypoints</code>æ”¹ä¸ºwebsecure,å³ä½¿ç”¨https
å†åœ¨è·¯ç”±é…ç½®æ·»åŠ ä¸€ä¸ªæŒ‡å®šä½¿ç”¨çš„è¯ä¹¦resolver</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>    labels:
</span><span>      - &quot;traefik.http.routers.syncthing.entrypoints=websecure&quot; # è®¾å®šå…¥å£ä¸ºwebsecureä¹Ÿå°±æ˜¯443
</span><span>      - &quot;traefik.http.routers.syncthing.tls.certresolver=myresolver&quot; # æŒ‡å®šè¯ä¹¦ç”³è¯·çš„resolver
</span></code></pre>
<p>æœ€ç»ˆé…ç½®å¦‚ä¸‹</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>version: &#39;3&#39;
</span><span>services:
</span><span>  syncthing:
</span><span>    image: syncthing/syncthing
</span><span>    container_name: syncthing
</span><span>    restart: unless-stopped
</span><span>    ulimits:
</span><span>      nproc: 65535
</span><span>      nofile:
</span><span>        soft: 65535
</span><span>        hard: 65535
</span><span>    volumes:
</span><span>      - /var/syncthing:/var/syncthing
</span><span>    environment:
</span><span>      - PUID=1000
</span><span>      - PGID=1000
</span><span>    ports:
</span><span>      - 8384:8384 # Web UI
</span><span>      - 22000:22000/tcp # TCP file transfers
</span><span>      - 22000:22000/udp # QUIC file transfers
</span><span>      - 21027:21027/udp # Receive local discovery broadcasts
</span><span>    labels:
</span><span>      - &quot;traefik.enable=true&quot;
</span><span>      - &quot;traefik.docker.network=traefik&quot;
</span><span>      # å½“å®¹å™¨åªæœ‰ä¸€ä¸ªç«¯å£çš„æ—¶å€™ï¼Œtraefiké»˜è®¤æŠŠæµé‡ä¼ ç»™è¿™ä¸ªç«¯å£,ä¸éœ€è¦é¢å¤–æŒ‡å®šç«¯å£
</span><span>      # ä½†å®¹å™¨æœ‰å¤šä¸ªç«¯å£æ˜ å°„æ—¶ï¼Œtraefikä¸çŸ¥é“è¦æŠŠæµé‡ä¼ ç»™å“ªä¸€ä¸ªç«¯å£,æ‰€ä»¥éœ€è¦é¢å¤–æŒ‡å®šä¸€ä¸ªç«¯å£
</span><span>      - &quot;traefik.http.services.syncthing.loadbalancer.server.port=8384&quot;
</span><span>      - &quot;traefik.http.routers.syncthing.rule=Host(`sync.example.com`)&quot;
</span><span>      - &quot;traefik.http.routers.syncthing.entrypoints=websecure&quot; # è®¾å®šå…¥å£ä¸ºwebsecureä¹Ÿå°±æ˜¯443
</span><span>      - &quot;traefik.http.routers.syncthing.tls.certresolver=myresolver&quot; # æŒ‡å®šè¯ä¹¦ç”³è¯·çš„resolver
</span><span>      # - ä¸‹é¢é…ç½®ä¸éœ€è¦ï¼Œç•™ç€ä»…ä¾›å‚è€ƒ
</span><span>      # - &quot;traefik.http.routers.syncthing.tls=true&quot; # å¼€å¯tls
</span><span>      # - &quot;traefik.http.services.syncthing.loadbalancer.server.scheme=http&quot; # æ˜ç¡®æŒ‡å®š HTTP
</span><span>    networks:
</span><span>      - traefik
</span><span>networks:
</span><span>  traefik:
</span><span>    external: true
</span></code></pre>
<p>ç„¶åå°±æœ‰tlsè¯ä¹¦äº†ï¼Œä¸”å¼ºåˆ¶ä½¿ç”¨https</p>
<p>ä¸‹é¢æ˜¯å®˜æ–¹ç¤ºä¾‹é…ç½®</p>
<pre data-lang="docker-compose.yml" style="background-color:#212733;color:#ccc9c2;" class="language-docker-compose.yml "><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span>version: &quot;3.3&quot;
</span><span>
</span><span>services:
</span><span>
</span><span>  traefik:
</span><span>    image: &quot;traefik:v3.2&quot;
</span><span>    container_name: &quot;traefik&quot;
</span><span>    command:
</span><span>      #- &quot;--log.level=DEBUG&quot;
</span><span>      - &quot;--api.insecure=true&quot;
</span><span>      - &quot;--providers.docker=true&quot;
</span><span>      - &quot;--providers.docker.exposedbydefault=false&quot;
</span><span>      - &quot;--entryPoints.websecure.address=:443&quot;
</span><span>      - &quot;--certificatesresolvers.myresolver.acme.tlschallenge=true&quot;
</span><span>      #- &quot;--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory&quot;
</span><span>      - &quot;--certificatesresolvers.myresolver.acme.email=postmaster@example.com&quot;
</span><span>      - &quot;--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json&quot;
</span><span>    ports:
</span><span>      - &quot;443:443&quot;
</span><span>      - &quot;8080:8080&quot;
</span><span>    volumes:
</span><span>      - &quot;./letsencrypt:/letsencrypt&quot;
</span><span>      - &quot;/var/run/docker.sock:/var/run/docker.sock:ro&quot;
</span><span>
</span><span>  whoami:
</span><span>    image: &quot;traefik/whoami&quot;
</span><span>    container_name: &quot;simple-service&quot;
</span><span>    labels:
</span><span>      - &quot;traefik.enable=true&quot;
</span><span>      # å› ä¸ºè¿™ä¸ªå®¹å™¨åªæš´éœ²ä¸€ä¸ª80ç«¯å£ï¼Œæ‰€ä»¥ä¸éœ€è¦ç‰¹åˆ«æŒ‡å®šç«¯å£
</span><span>      - &quot;traefik.http.routers.whoami.rule=Host(`whoami.example.com`)&quot;
</span><span>      - &quot;traefik.http.routers.whoami.entrypoints=websecure&quot;
</span><span>      - &quot;traefik.http.routers.whoami.tls.certresolver=myresolver&quot;
</span></code></pre>
<h2 id="nixos">NixOS</h2>
<p>æœ‰äº†dockerçš„åŸºç¡€ï¼Œé…ç½®è¾ƒä¸ºç®€å•ï¼Œæ˜“äºç†è§£ï¼ŒåŸºæœ¬æ˜¯æŠŠdockerçš„ç›¸å…³é…ç½®å˜æˆjsonçš„å½¢å¼ï¼Œç›´æ¥ä½¿ç”¨nixè¯­è¨€è¿›è¡Œé…ç½®
ç¤ºä¾‹<code>traefik.nix</code></p>
<pre data-lang="traefik.nix" style="background-color:#212733;color:#ccc9c2;" class="language-traefik.nix "><code class="language-traefik.nix" data-lang="traefik.nix"><span>{
</span><span>  config,
</span><span>  pkgs,
</span><span>  host,
</span><span>  ...
</span><span>}:
</span><span>{
</span><span>  # å¼€å¯syncthingå’Œnetdata
</span><span>  services = {
</span><span>      syncthing = {
</span><span>          enable = true;
</span><span>      };
</span><span>  };
</span><span>  services.netdata = {
</span><span>    enable = true;
</span><span>  };
</span><span>  # å¼€å¯ traefik
</span><span>  services.traefik = {
</span><span>    enable = true;
</span><span>
</span><span>    # é™æ€é…ç½®
</span><span>    staticConfigOptions = {
</span><span>      # éœ€è¦æ—¥å¿—å¯ä»¥æ·»åŠ ä¸‹é¢çš„é…ç½®
</span><span>      # log = {
</span><span>        # level = &quot;INFO&quot;;
</span><span>        # filePath = &quot;${config.services.traefik.dataDir}/traefik.log&quot;;
</span><span>        # format = &quot;json&quot;;
</span><span>      # };
</span><span>
</span><span>      # å®šä¹‰å…¥å£ï¼Œåå­—æ˜¯websecure,ä»…è®¾ç½®:443
</span><span>      entryPoints = {
</span><span>        # web = {
</span><span>        #   address = &quot;:80&quot;;
</span><span>        # };
</span><span>        websecure= {
</span><span>          address = &quot;:443&quot;;
</span><span>        # åœ¨ä¸‹é¢åŠ¨æ€é…ç½®å·²ç»æŒ‡å®šè¿‡äº†
</span><span>	      # http.tls.certResolver = &quot;myresolver&quot;;
</span><span>        };
</span><span>      };
</span><span>
</span><span>      # å®šä¹‰è¯ä¹¦ç”³è¯·å™¨,myresolveræ˜¯æˆ‘å®šä¹‰çš„è¯ä¹¦ç”³è¯·å™¨çš„åå­—ï¼Œåå­—å¯ä»¥éšä¾¿èµ·
</span><span>      certificatesResolvers.myresolver.acme = {
</span><span>	    tlschallenge = true;
</span><span>        email = &quot;example@email.com&quot;;
</span><span>        storage = &quot;${config.services.traefik.dataDir}/acme.json&quot;;
</span><span>      #   httpChallenge.entryPoint = &quot;web&quot;;
</span><span>      };
</span><span>
</span><span>      # å¼€å¯é¢æ¿
</span><span>      api.dashboard = true;
</span><span>      # Access the Traefik dashboard on &lt;Traefik IP&gt;:8080 of your server
</span><span>      api.insecure = true;
</span><span>    };
</span><span>
</span><span>    # åŠ¨æ€é…ç½®
</span><span>    dynamicConfigOptions = {
</span><span>      # ä½¿ç”¨httpåè®®
</span><span>      http = {
</span><span>        routers = {
</span><span>          # å®šä¹‰2ä¸ªè·¯ç”±åå­—ï¼Œä¸€ä¸ªæ˜¯syncthingï¼Œä¸€ä¸ªæ˜¯netdata,åå­—å¯ä»¥éšä¾¿èµ·
</span><span>          syncthing= {
</span><span>            # å®šä¹‰å…¥å£ä¸ºwebsecure,ä¹Ÿå°±æ˜¯443
</span><span>	          entryPoints = [ &quot;websecure&quot; ];
</span><span>            # è®¾ç½®è§„åˆ™ä¸ºåŒ¹é…åŸŸå
</span><span>            rule = &quot;Host(`sync.example.com`)&quot;;
</span><span>            # æŒ‡å®šè·Ÿè·¯ç”±ç›¸å…³è”çš„æœåŠ¡(service)
</span><span>            service = &quot;syncthing&quot;;
</span><span>            # æŒ‡å®šè·¯ç”±ä½¿ç”¨çš„è¯ä¹¦ç”³è¯·å™¨
</span><span>	          tls.certresolver = &quot;myresolver&quot;;
</span><span>          };
</span><span>          # ç¬¬äºŒä¸ªè·¯ç”±ï¼Œè·Ÿç¬¬ä¸€ä¸ªåŒç†
</span><span>          netdata= {
</span><span>	          entryPoints = [ &quot;websecure&quot; ];
</span><span>            rule = &quot;Host(`data.example.com`)&quot;;
</span><span>            service = &quot;netdata&quot;;
</span><span>	          tls.certresolver = &quot;myresolver&quot;;
</span><span>          };
</span><span>        };
</span><span>        # å®šä¹‰æœåŠ¡
</span><span>        services = {
</span><span>          # å®šä¹‰2ä¸ªæœåŠ¡åå­—ï¼Œä¸€ä¸ªå«syncthing,ä¸€ä¸ªå«netdataï¼Œåå­—å¯ä»¥éšä¾¿èµ·ï¼Œå¯ä»¥ä¸å…¥å£ï¼Œè·¯ç”±çš„åå­—é‡å
</span><span>          syncthing = {
</span><span>            loadBalancer = {
</span><span>              # serveré‡Œé¢é…ç½®webuiç•Œé¢ç›‘å¬çš„åœ°å€å³å¯
</span><span>              servers = [
</span><span>                {
</span><span>                  url = &quot;http://localhost:8384&quot;;
</span><span>                }
</span><span>              ];
</span><span>              # syncthingä¸åŠ ä¸‹é¢è¿™è¡Œé…ç½®æ— æ³•æ­£å¸¸è®¿é—®,å…¶ä»–è¯·ç•¥è¿‡è¿™ä¸ª
</span><span>              passHostHeader = false;
</span><span>            };
</span><span>          };
</span><span>          netdata = {
</span><span>            loadBalancer = {
</span><span>              servers = [
</span><span>                {
</span><span>                  url = &quot;http://localhost:19999&quot;;
</span><span>                }
</span><span>              ];
</span><span>            };
</span><span>          };
</span><span>        };
</span><span>     };
</span><span>    };
</span><span>  };
</span><span>}
</span><span>
</span></code></pre>
<p>ç„¶åï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨<code>traefik.nix</code></p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>{
</span><span>  config,
</span><span>  pkgs,
</span><span>  host,
</span><span>  ...
</span><span>}:
</span><span>{
</span><span>  ...
</span><span>  imports = [
</span><span>    traefik.nix
</span><span>  ];
</span><span>  ...
</span><span>}
</span></code></pre>
<p>ç„¶åï¼Œé‡æ„ç³»ç»Ÿ</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">sudo</span><span> nixos-rebuild switch
</span></code></pre>
<p>æˆ–è€…
ä½¿ç”¨flake</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">sudo</span><span> nixos-rebuild switch</span><span style="color:#ffcc66;"> --flake</span><span> .#</span><span style="color:#bae67e;">&quot;$</span><span>HOSTNAME</span><span style="color:#bae67e;">&quot;
</span></code></pre>
<p>è®¿é—®åŸŸåï¼Œç¡®è®¤åä»£æˆåŠŸ</p>

      </div>
    </div>
    <div class="prompt" id="terminal"><input
    type="text"
    id="setter"
    onkeydown="writeit(this, event);moveIt(this.value.length, event)"
    onchange="writeit(this, event)"
    onkeyup="writeit(this, event)"
    onkeypress="writeit(this, event);"
    >
<label for="setter" id="writer"> </label><b class="cursor" id="cursor"></b></div>
  </main>
</body>
</html>
