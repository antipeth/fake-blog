<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ATP</title>
     <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js" integrity="sha256-WCzAhd2P6gRJF9Hv3oOOd+hFJi/QJbv+Azn4CGB8gfY=" crossorigin="anonymous"></script>
     <script src="/js/index.js"></script>
     <script src="/js/prompt.js"></script>
     <script src="/js/keyboard.js"></script>
     <script src="/js/tab.js"></script>
     <script src="/js/commands.js"></script>
     <script src="/js/config.js"></script><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="/css/page.css"></head>
<body onkeydown='exec(event)'>
  <header>
      <h1>ATP</h1>
  </header>
  <main>
    <div class="files" id="files" tabindex="0">
<ul><li class="file">
    <span><a href='https://blog.0pt.icu/readme/'
      tabindex="-2">ï’¥  README</a></span>
  </li><li class="file">
    <span><a href='https://blog.0pt.icu/rss/'
      tabindex="-3">ï’¥  RSS</a></span>
  </li><li class="folder"><span>
      
      <a href='https://blog.0pt.icu/posts/'
        tabindex="-4">ï“  Posts
      </a>
    </span>

    <ul>
      
        
        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/think/'
    tabindex="-5">ï“  Think
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/2024/'
        tabindex="-6">ï’¥  2024</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/unhappy-newyear/'
        tabindex="-7">ï’¥  ç¥ä½ æ˜¥èŠ‚ä¸å¿«ä¹</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/1st-anniversary-of-listening-to-tayu-lo/'
        tabindex="-8">ï’¥  çºªå¿µå¬ç½—å¤§ä½‘ä¸€å‘¨å¹´</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/music-history/'
        tabindex="-9">ï’¥  è®°æˆ‘çš„å¬æ­Œå†ç¨‹</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/think/my-first-post/'
        tabindex="-10">ï’¥  My first post</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/homelab/'
    tabindex="-11">ï“  homelab
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/homelab/nixos-nas/'
        tabindex="-12">ï’¥  My NixOS NASğŸ§Š</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/linux-trip/'
    tabindex="-13">ï“  Linux Trip
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/7/'
        tabindex="-14">ï’¥  ç¬¬ä¸ƒå›ï¼Œæ¢FreeBSDè·¯é€”è¿œï¼Œåå·è†æ£˜å‹‡å‰è¡Œ</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/6/'
        tabindex="-15">ï’¥  ç¬¬å…­å›ï¼Œå¼ƒLinuxæŠ•FreeBSDï¼Œç¨³å¦‚ç£çŸ³è·¯æ›´å®½</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/5/'
        tabindex="-16">ï’¥  ç¬¬äº”å›ï¼Œæ¸è§‰Archæ— åŠ›æŒï¼Œè½¬æŠ•NixOSè·æ–°ç”Ÿ</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/4/'
        tabindex="-17">ï’¥  ç¬¬å››å›ï¼ŒèˆKDEæŠ±Hyprlandï¼Œæ–°å¢ƒç•Œè¿½æ±‚æ›´æ·»</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/3/'
        tabindex="-18">ï’¥  ç¬¬ä¸‰å›ï¼Œæ¢å¹½å¯»ç§˜APPSæ–°ï¼Œè§£CONFIGå¥‡è¶£å…¥çœ¼å‰</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/2/'
        tabindex="-19">ï’¥  ç¬¬äºŒå›ï¼Œåˆå…¥KDEè™šç•Œé—´ï¼Œå®‰è£…APPSè€€ç›®å…‰</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/linux-trip/1/'
        tabindex="-20">ï’¥  ç¬¬ä¸€å›ï¼Œå¼ƒwindowæ¸å…¥è½»ç›ˆå¢ƒï¼Œè£…Archèµ°å…¥å‘æ·±åº•</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/k3s/'
    tabindex="-21">ï“  K3S
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/k3s/develop-rancher/'
        tabindex="-22">ï’¥  k3séƒ¨ç½²rancher</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/k3s/kubevirt-manager/'
        tabindex="-23">ï’¥  k3séƒ¨ç½²kubevirt-manager</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/pve/'
    tabindex="-24">ï“  PVE
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/pve/pve-hackintosh/'
        tabindex="-25">ï’¥  x79ä¸Špveé»‘è‹¹æœ</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a class="selected"href='https://blog.0pt.icu/posts/pve/build-pve/'
        tabindex="-26">ï’¥  x79æ­å»ºpveå¹¶å¼€å¯ç¡¬ä»¶ç›´é€š</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/server/'
    tabindex="-27">ï“  server
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/traefik-simple-guide/'
        tabindex="-28">ï’¥  Docker/NixOSä½¿ç”¨traefikå®ç°ç®€å•åä»£</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/caddy-simple-guide/'
        tabindex="-29">ï’¥  Debian/NixOSä½¿ç”¨caddyå®ç°ç®€å•åä»£</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/use-tebi-build-nixos-cache-server/'
        tabindex="-30">ï’¥  ä½¿ç”¨tebiä½œä¸ºs3,æ­å»ºnixç¼“å­˜æœåŠ¡å™¨</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/cloudfront-cdn-acme/'
        tabindex="-31">ï’¥  cloudfronté…ç½®å°é¸¡cdnå¹¶ä½¿ç”¨acme.shè‡ªåŠ¨è·å–è¯ä¹¦</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/build-terraria-tshock/'
        tabindex="-32">ï’¥  æ­å»ºæ³°æ‹‰ç‘äºšTshockæœåŠ¡å™¨(å¼ºåˆ¶å¼€è’)</a>
    </span>
  </li><li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/server/build-hugo/'
        tabindex="-33">ï’¥  åŸºäºArch Linuxæ­å»ºhugoåšå®¢</a>
    </span>
  </li></ul>
</li>

        
          
          
<li>
<span>â””â”€â”€
  
  <a href='https://blog.0pt.icu/posts/hackintosh/'
    tabindex="-34">ï“  Hackintosh
  </a>
</span>


  <ul>
  <li class="file">
    <span>â””â”€â”€
      <a href='https://blog.0pt.icu/posts/hackintosh/x79/'
        tabindex="-35">ï’¥  è®°å½•ä¸€æ¬¡æ‚ç‰Œx79é»‘è‹¹æœ</a>
    </span>
  </li></ul>
</li>

        
    </ul>
  </li><li class="folder"><span>
      
      <a href='https://blog.0pt.icu/about/'
        tabindex="-36">ï“  ABOUT
      </a>
    </span>

    <ul>
      <li class="file">
        <span>â””â”€â”€
          <a href='https://blog.0pt.icu/about/about2/'
            tabindex="-37">ï’¥  ABOUT2</a>
        </span>
      </li><li class="file">
        <span>â””â”€â”€
          <a href='https://blog.0pt.icu/about/about1/'
            tabindex="-38">ï’¥  ABOUT1</a>
        </span>
      </li>
        
    </ul>
  </li><li class="folder"><span>
      
      <a href='https://blog.0pt.icu/links/'
        tabindex="-39">ï“  LINKS
      </a>
    </span>

    <ul>
      <li class="file">
        <span>â””â”€â”€
          <a href='https://blog.0pt.icu/links/link/'
            tabindex="-40">ï’¥  LINKS</a>
        </span>
      </li>
        
    </ul>
  </li>
</ul>
</div>
    <div class="viewer page" id="viewer" tabindex="0">
      <div class="tab">
<ul id="tabs">
</ul>


</div>
      <div class="content" id="content"><h1 id="x79da-jian-pvebing-kai-qi-ying-jian-zhi-tong">x79æ­å»ºpveå¹¶å¼€å¯ç¡¬ä»¶ç›´é€š</h1>
<p>2024-09-17</p>
<p>ä»å»å¹´å°±ä¹°äº†ä¸€ä¸ªæœåŠ¡å™¨ä¸»æ¿å’Œç›¸å…³é…ä»¶å­¦ä¹ è£…æœºï¼Œä¸€ç›´éƒ½æ²¡ç”¨èµ·æ¥ã€‚å¼€å­¦åæƒ³ç€åˆ©ç”¨èµ·æ¥ï¼Œå¼€ä¸ªpveç©ç©ã€‚</p>
<h2 id="ying-jian-pei-zhi">ç¡¬ä»¶é…ç½®</h2>
<table><thead><tr><th>Item</th><th>name</th><th>price</th></tr></thead><tbody>
<tr><td>ä¸»æ¿</td><td>x79æµªæ½®m2220(2011é’ˆ)</td><td>152ï¿¥</td></tr>
<tr><td>cpu</td><td>è‡³å¼ºe5-2651v2 x 2</td><td>26x2=52ï¿¥</td></tr>
<tr><td>å†…å­˜</td><td>1866Mhzé•å…‰16G ddr3æœåŠ¡å™¨å†…å­˜æ¡ x 2</td><td>27x2=54ï¿¥</td></tr>
<tr><td>æ•£çƒ­å™¨</td><td>æ‚ç‰Œå¡”å¼æ•£çƒ­ x 2</td><td>29x2=58ï¿¥</td></tr>
<tr><td>æ˜¾å¡</td><td>ç›ˆé€šæ¸¸æˆé«˜æ‰‹R9 270</td><td>120ï¿¥</td></tr>
<tr><td>ç¡¬ç›˜</td><td>æ¢µæƒ³ssdå›ºæ€128G</td><td>79ï¿¥</td></tr>
<tr><td>ç”µæº</td><td>åä¸ºæœåŠ¡å™¨ç”µæº750w+ç”µæºè½¬æ¥æ¿+æ¨¡ç»„çº¿</td><td>41+71+65=177ï¿¥</td></tr>
<tr><td>æœºç®±</td><td>å¼€æ”¾å¼æœºç®±</td><td>39ï¿¥</td></tr>
<tr><td>æ€»è®¡</td><td></td><td>731ï¿¥</td></tr>
</tbody></table>
<h2 id="zhu-ban-jie-shao">ä¸»æ¿ä»‹ç»</h2>
<table><thead><tr><th>Item</th><th>name</th></tr></thead><tbody>
<tr><td>ä¸»æ¿å°ºå¯¸</td><td>E-ATX 30.5cm x 33.2cm</td></tr>
<tr><td>å†…å­˜</td><td>4é€šé“ 20ä¸ªddr3</td></tr>
<tr><td>sata</td><td>2ä¸ªsata3 8ä¸ªsata2</td></tr>
<tr><td>pcie</td><td>3ä¸ªpci-e 16x 3ä¸ªpci-e 8x</td></tr>
<tr><td>usb</td><td>3ä¸ªusb2</td></tr>
<tr><td>vga</td><td>æ¿è½½æ˜¾å¡ï¼Œæœ‰1ä¸ªvgaå£</td></tr>
<tr><td>ç½‘å£</td><td>2ä¸ªåƒå…†ç½‘å£(intel i350èŠ¯ç‰‡) 1ä¸ªè¿œç¨‹å£(IPMI)</td></tr>
</tbody></table>
<h2 id="zhu-yi-shi-xiang">æ³¨æ„äº‹é¡¹</h2>
<h3 id="xian-qia">æ˜¾å¡</h3>
<p>æ˜¾å¡åˆ«çœ‹pci-e 16x æœ‰3ä¸ªï¼Œèƒ½æ”¯æŒçš„æ˜¾å¡é•¿åº¦å¿…é¡»å°äº18.5cmï¼Œä¸ç„¶ä¼šé¡¶åˆ°å†…å­˜æ’æ§½ï¼Œä¸”å¦‚æœæ˜¾å¡å®½åº¦å¤§äº1.5cm,åˆ™ä¼šæŠŠæ—è¾¹çš„é‚£ä¸ªpcieå£ä¸€èµ·å ç”¨ã€‚
æ¿è½½æ˜¾å¡åœ¨æŸäº›æƒ…å†µï¼ˆéæ­£å¸¸æƒ…å†µï¼‰ä¸‹å¯èƒ½ä¼šæœ‰å†²çªã€‚</p>
<h3 id="san-re-qi">æ•£çƒ­å™¨</h3>
<p>æ³¨æ„ä¹°æ ‡å‡†çš„é•¿æ–¹å½¢2011é’ˆï¼Œä¸æ˜¯æ­£æ–¹å½¢ã€‚</p>
<h2 id="biosshe-zhi">BIOSè®¾ç½®</h2>
<p>æŒ‰<code>Del</code>è¿›bios</p>
<h3 id="cpu">cpu</h3>
<p>vt-då¼€å¯ï¼Œè™šæ‹ŸåŒ–å¼€å¯
cpuçš„å‡ ä¸ªå¢å¼ºè®¾ç½®å…¨éƒ¨æ‰“å¼€</p>
<h3 id="ying-pan">ç¡¬ç›˜</h3>
<p><code>Advanced</code>-&gt;<code>SATA Configuration</code>-&gt;<code>SATA Mode</code> ,æŠŠ<code>IDE Mode</code>æ”¹ä¸º<code>AHCI Mode</code></p>
<h3 id="shi-pin-shu-chu-xin-hao-zou-ban-zai-xian-qia-gai-wei-zou-du-xian">è§†é¢‘è¾“å‡ºä¿¡å·èµ°æ¿è½½æ˜¾å¡æ”¹ä¸ºèµ°ç‹¬æ˜¾</h3>
<p><code>Chipset</code>-&gt;<code>CPU Advanced Settings</code>-&gt;<code>IOH Configuration</code>-&gt;<code>VGA Priority</code>,æŠŠ<code>Onboard</code>æ”¹ä¸º<code>Offboard</code></p>
<h2 id="an-zhuang-pve">å®‰è£…pve</h2>
<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥å®‰è£…å³å¯</p>
<h2 id="pvezhu-yi-shi-xiang">pveæ³¨æ„äº‹é¡¹</h2>
<h3 id="shi-yong-wu-xian-wang-qia-lian-wang">ä½¿ç”¨æ— çº¿ç½‘å¡è”ç½‘</h3>
<p>æ— çº¿ç½‘å¡è¿æ¥æ‰‹æœºçƒ­ç‚¹ï¼Œå¹¶ä½¿ç”¨naté…ç½®ç»™è™šæ‹Ÿæœºè”ç½‘ï¼Œæˆ‘ä½¿ç”¨è¿™ç§æ–¹æ³•æœ‰é—®é¢˜ï¼Œè™šæ‹Ÿæœºå†…æ— ç½‘ç»œ(æˆ‘çœ‹åˆ«äººçš„ç›¸å…³æ–‡ç« ï¼Œæ— çº¿ç½‘å¡è¿æ¥çš„æ˜¯è·¯ç”±å™¨wifiï¼ŒæˆåŠŸé…ç½®ç½‘ç»œã€‚)</p>
<h3 id="shi-yong-usblian-wang">ä½¿ç”¨usbè”ç½‘</h3>
<p>usbç½‘è·¯å…±äº«ä¹Ÿæœ‰é—®é¢˜ï¼Œæ¯æ¬¡éœ€è¦æ‰‹åŠ¨é…ç½®ç½‘ç»œæ¥å£ã€‚ä½¿ç”¨ä»¥ä¸‹è„šæœ¬
é€šè¿‡æ‰‹æœº rndis è‡ªåŠ¨è”ç½‘é…ç½®
æ•ˆæœæ˜¯ï¼šæ‰‹æœºçº¿è¿æ¥ pve å¼€å¯ USB ç½‘ç»œå…±äº«åï¼Œ5ç§’å·¦å³è‡ªåŠ¨é…ç½®å¥½ rndis ç½‘ç»œ</p>
<p>ä»£ç éƒ¨åˆ†ï¼š</p>
<p>/etc/systemd/system/rndis.service</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>[Unit]
</span><span>Description=Run RNDIS script every 5 seconds
</span><span>After=network.target
</span><span>
</span><span>[Service]
</span><span>ExecStart=bash /root/rndis.sh
</span><span>Restart=always
</span><span>RestartSec=5
</span><span>
</span><span>[Install]
</span><span>WantedBy=multi-user.target
</span></code></pre>
<p>/root/rndis.sh</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>#!/bin/bash
</span><span>
</span><span>ANDROID_USB_IP=&quot;192.168.42.100&quot;
</span><span>ANDROID_USB_GATEWAY=&quot;192.168.42.1&quot;
</span><span>ANDROID_USB_SUBNET=&quot;255.255.255.0&quot;
</span><span>PVE_DEFAULT_GATEWAY=&quot;192.168.100.1&quot;
</span><span>
</span><span># è·å– enx å¼€å¤´çš„ç½‘å¡è®¾å¤‡åç§°
</span><span>enx_interface=$(ip a | grep &quot;enx[0-9a-f:]*:&quot; | awk &#39;{print $2}&#39; | head -n 1 | sed &#39;s/:$//&#39;)
</span><span>
</span><span># æ£€æŸ¥æ˜¯å¦è·å–åˆ°ç½‘å¡åç§°
</span><span>if [ -z &quot;$enx_interface&quot; ]; then
</span><span>  echo &quot;Error: Could not find enx interface.&quot;
</span><span>  exit 1
</span><span>fi
</span><span>
</span><span># æ‰“å°è¾“å‡ºç½‘å¡åç§°
</span><span>echo &quot;Detected enx interface: $enx_interface&quot;
</span><span>
</span><span># å¤‡ä»½ /etc/network/interfaces
</span><span>if [ -f /etc/network/interfaces.bak ]; then
</span><span>  rm /etc/network/interfaces.bak
</span><span>  echo &quot;Delete original backup.&quot;
</span><span>fi
</span><span>cp /etc/network/interfaces /etc/network/interfaces.bak
</span><span>echo &quot;Backup /etc/network/interfaces&quot;
</span><span>
</span><span># æ£€æŸ¥ /etc/network/interfaces æ˜¯å¦åŒ…å« enx[mac] å­—æ®µ
</span><span>if grep -q &quot;enx[0-9a-f]*&quot; /etc/network/interfaces; then
</span><span>  # æ£€æŸ¥æ˜¯å¦ä¸æ–°è·å–çš„ç½‘å¡åç§°ç›¸åŒ
</span><span>  if grep -q &quot;$enx_interface&quot; /etc/network/interfaces; then
</span><span>    echo &quot;Network interface name already matches, no changes made.&quot;
</span><span>  else
</span><span>    # æ›¿æ¢ /etc/network/interfaces ä¸­çš„ç½‘å¡åç§°
</span><span>    sed -i &quot;s/enx[0-9a-f]*/$enx_interface/g&quot; /etc/network/interfaces
</span><span>    echo &quot;Network interface name updated in /etc/network/interfaces.&quot;
</span><span>  fi
</span><span>else
</span><span>  # è¿½åŠ æ–°çš„ç½‘å¡é…ç½®
</span><span>  cat &gt;&gt; /etc/network/interfaces &lt;&lt;EOF
</span><span>
</span><span>auto $enx_interface
</span><span>iface $enx_interface inet static
</span><span>        address $ANDROID_USB_IP
</span><span>        netmask $ANDROID_USB_SUBNET
</span><span>        gateway $ANDROID_USB_GATEWAY
</span><span>EOF
</span><span>  echo &quot;New network interface configuration appended to /etc/network/interfaces.&quot;
</span><span>fi
</span><span>
</span><span># åˆ é™¤æ—§è·¯ç”±å¹¶æ·»åŠ æ–°è·¯ç”±
</span><span>ip route delete default via $PVE_DEFAULT_GATEWAY
</span><span>ip route add default via $ANDROID_USB_GATEWAY
</span><span>
</span><span>echo &quot;Network configuration updated successfully.&quot;
</span><span>
</span><span># æ£€æŸ¥ç½‘ç»œè¿æ¥
</span><span>if ! ping -c 1 1.1.1.1 &gt; /dev/null 2&gt;&amp;1; then
</span><span>    echo &quot;Network is down, restarting networking service...&quot;
</span><span>    # ä»…å½“ç½‘ç»œä¸å¯ç”¨æ—¶é‡å¯ç½‘ç»œæœåŠ¡
</span><span>    systemctl restart networking.service
</span><span>else
</span><span>    echo &quot;Network is up.&quot;
</span><span>fi
</span><span>    echo &quot;Done.&quot;
</span></code></pre>
<h2 id="kai-qi-zhi-tong">å¼€å¯ç›´é€š</h2>
<p>å‚è€ƒ<a href="https://pve.sqlsec.com/4/2/">å›½å…‰çš„æ•™ç¨‹</a>
ä»¥ä¸‹æ˜¯è‡ªå·±é…çš„</p>
<h3 id="kai-qi-iommu">å¼€å¯IOMMU</h3>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>nano /etc/default/grub
</span></code></pre>
<p>å°†</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet&quot;
</span></code></pre>
<p>æ”¹ä¸º(åŒ…å«ç›´é€šä¼˜åŒ–ï¼Œå…³é—­æ˜¾å¡ä»¥èŠ‚èƒ½çš„ç›¸å…³å‚æ•°)</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on iommu=pt textonly nomodeset nofb pci=noaer pcie_acs_override=downstream,multifunction video=vesafb:off video=efifb:off video=simplefb:off initcall_blacklist=sysfb_init&quot;
</span></code></pre>
<p>ç„¶åä½¿ç”¨</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>update-grub
</span></code></pre>
<p>éªŒè¯IOMMUæ˜¯å¦å¼€å¯</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>dmesg | grep -e DMAR -e IOMMU
</span></code></pre>
<p>å‡ºç°<code>DMAR: IOMMU enabled</code>åˆ™è¯´æ˜å¼€å¯æˆåŠŸï¼Œè¿˜ä¸è¡Œé‡å¯åå†çœ‹ä¸€ä¸‹ã€‚</p>
<h3 id="tian-jia-vfio-mo-kuai">æ·»åŠ  VFIO æ¨¡å—</h3>
<p>ä¸ºäº†æˆ‘ä»¬çš„æ˜¾å¡é¡ºåˆ©ç›´é€šï¼Œéœ€è¦æ·»åŠ  VFIO æ¨¡å—åˆ° /etc/modules æ–‡ä»¶ä¸­ï¼š</p>
<pre data-lang="Bash" style="background-color:#212733;color:#ccc9c2;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;vfio&quot; </span><span style="color:#f29e74;">&gt;</span><span> /etc/modules
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;vfio_iommu_type1s&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modules
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;vfio_pci&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modules
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;vfio_virqfd&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modules
</span></code></pre>
<p>å°†å¸¸è§çš„é©±åŠ¨ç¨‹åºåŠ å…¥é»‘åå•ï¼Œå³è®© GPU ç›¸å…³è®¾å¤‡åœ¨ä¸‹æ¬¡ç³»ç»Ÿå¯åŠ¨ä¹‹åä¸ä½¿ç”¨è¿™äº›é©±åŠ¨ï¼ŒæŠŠè®¾å¤‡è…¾å‡ºæ¥ç»™ vfio é©±åŠ¨ç”¨ï¼š</p>
<pre data-lang="Bash" style="background-color:#212733;color:#ccc9c2;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist nvidiafb&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist nouveau&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist nvidia&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist radeon&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist amdgpu&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist snd_hda_intel&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist snd_hda_codec_hdmi&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span><span style="color:#f28779;">echo </span><span style="color:#bae67e;">&quot;blacklist i915&quot; </span><span style="color:#f29e74;">&gt;&gt;</span><span> /etc/modprobe.d/blacklist.conf
</span></code></pre>
<p>ç„¶åæ›´æ–°å†…æ ¸é‡å¯æœºå™¨ï¼š</p>
<pre data-lang="Bash" style="background-color:#212733;color:#ccc9c2;" class="language-Bash "><code class="language-Bash" data-lang="Bash"><span style="color:#ffd580;">update-initramfs</span><span style="color:#ffcc66;"> -u </span><span style="color:#f29e74;">&amp;&amp; </span><span style="color:#ffd580;">reboot
</span></code></pre>
<h3 id="yan-zheng-iommu-zhong-duan-zhong-xin-ying-she-shi-fou-yi-qi-yong">éªŒè¯ IOMMU ä¸­æ–­é‡æ–°æ˜ å°„æ˜¯å¦å·²å¯ç”¨</h3>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>dmesg | grep &#39;remapping&#39;
</span></code></pre>
<p>çœ‹åˆ°ä»¥ä¸‹è¡Œä¹‹ä¸€ï¼š</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>AMD-Vi: Interrupt remapping enabled
</span><span>DMAR-IR: Enabled IRQ remapping in x2apic mode
</span></code></pre>
<h3 id="bu-zhi-dao-zhe-shi-sha">ä¸çŸ¥é“è¿™æ˜¯å•¥</h3>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>nano /etc/modprobe.d/pve-blacklist.conf
</span></code></pre>
<p>æ·»åŠ </p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>options vfio_iommu_type1 allow_unsafe_interrupts=1
</span></code></pre>
<h3 id="sheng-cheng-xian-qia-romfile">ç”Ÿæˆæ˜¾å¡romfile</h3>
<p>åœ¨windowä¸‹ï¼Œä½¿ç”¨gpu-zæå–ã€‚
æŠŠ<code>.romæ–‡ä»¶</code>ï¼ˆæˆ‘çš„æ˜¯R9-270.romï¼‰æ”¾åˆ°pveçš„<code>/usr/share/kvm/</code>ç›®å½•ä¸‹é¢
åœ¨è™šæ‹Ÿæœºé…ç½®ä¸‹æ·»åŠ pcieè®¾å¤‡ï¼Œé€‰æ‹©æ˜¾å¡ï¼Œå‹¾é€‰ä¸»<code>gpu</code>å’Œ<code>rombar</code>
ç¼–è¾‘è™šæ‹Ÿæœºé…ç½®</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>nano /etc/pve/qemu-server/100.conf
</span></code></pre>
<p>ä¿®æ”¹</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span># hostpci0: 01:00
</span><span>hostpci0: 01:00,x-vga=1,romfile=R9-270.rom
</span></code></pre>
<h3 id="pei-zhi-ying-pan-zhi-tong">é…ç½®ç¡¬ç›˜ç›´é€š</h3>
<p>å‚è€ƒ<a href="https://foxi.buduanwang.vip/virtualization/1754.html/">ä½›è¥¿åšå®¢</a>
æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤ï¼Œåˆ—å‡ºå½“å‰çš„ç¡¬ç›˜åˆ—è¡¨</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>ls -la /dev/disk/by-id/|grep -v dm|grep -v lvm|grep -v part
</span></code></pre>
<p>å¦‚ä¸‹é¢çš„ä¾‹å­</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>root@pve:~# ls -la /dev/disk/by-id/|grep -v dm|grep -v lvm|grep -v part
</span><span>total 0
</span><span>drwxr-xr-x 2 root root 540 Apr 28 16:39 .
</span><span>drwxr-xr-x 6 root root 120 Mar  3 15:52 ..
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 16:39 nvme-eui.01000000010000005cd2e431fee65251 -&gt; ../../nvme2n1
</span><span>lrwxrwxrwx 1 root root  13 Mar  3 15:52 nvme-eui.334843304aa010020025385800000004 -&gt; ../../nvme1n1
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 17:36 nvme-eui.334843304ab005400025385800000004 -&gt; ../../nvme0n1
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 16:39 nvme-INTEL_SSDPE2KX020T8_BTLJ039307142P0BGN -&gt; ../../nvme2n1
</span><span>lrwxrwxrwx 1 root root  13 Mar  3 15:52 nvme-SAMSUNG_MZWLL800HEHP-00003_S3HCNX0JA01002 -&gt; ../../nvme1n1
</span><span>lrwxrwxrwx 1 root root  13 Apr 28 17:36 nvme-SAMSUNG_MZWLL800HEHP-00003_S3HCNX0JB00540 -&gt; ../../nvme0n1
</span><span>lrwxrwxrwx 1 root root   9 Mar  3 15:52 scsi-35000c500474cd7eb -&gt; ../../sda
</span><span>lrwxrwxrwx 1 root root   9 Mar  3 15:52 wwn-0x5000c500474cd7eb -&gt; ../../sda
</span></code></pre>
<p>nvmeå¼€å¤´çš„æ˜¯nvmeç¡¬ç›˜ï¼Œataå¼€å¤´æ˜¯èµ°sataæˆ–è€…ataé€šé“çš„è®¾å¤‡ã€‚ï¼Œscsiæ˜¯scsiè®¾å¤‡-é˜µåˆ—å¡raidæˆ–è€…æ˜¯ç›´é€šå¡ä¸Šçš„ç¡¬ç›˜ã€‚
æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>qm set &lt;vmid&gt; --scsiX /dev/disk/by-id/xxxxxxx</code> è¿›è¡ŒRDMç›´é€š</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>#   è™šæ‹Ÿæœºç¼–å· æ§åˆ¶å™¨ç±»å‹ç¼–å· ç‰©ç†ç£ç›˜æŒ‚è½½ç‚¹
</span><span>qm set 101 --scsi1 /dev/disk/by-id/nvme-INTEL_SSDPE2KX020T8_BTLJ039307142P0BGN
</span></code></pre>
<h3 id="jiang-jing-xiang-xie-cheng-ci-pan-ge-shi">å°†é•œåƒå†™æˆç£ç›˜æ ¼å¼</h3>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>#                    è™šæ‹Ÿæœºç¼–å·           å­˜æ”¾é•œåƒçš„ä½ç½®                                      å‚¨å­˜æ± 
</span><span>qm disk import 100 /var/lib/vz/template/iso/openwrt.img local-lvm
</span></code></pre>
<p>å‚è€ƒè¿æ¥
https://pve.proxmox.com/wiki/PCI_Passthrough#Verify_IOMMU_is_enabled
https://www.bilibili.com/opus/848481909029732376?spm_id_from=333.976.0.0
https://www.bilibili.com/read/cv34418465/
https://pve.sqlsec.com/7/4/#_2</p>
<h2 id="pei-zhi-sheng-dian">é…ç½®çœç”µ</h2>
<p>å®‰è£…<code>cpupower</code></p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>apt install cpupower
</span><span>
</span><span># è®¾ç½®æ‰€æœ‰CPUä¸ºèŠ‚èƒ½æ¨¡å¼
</span><span>cpupower -c all frequency-set -g powersave
</span><span>
</span><span># è®¾ç½®æ‰€æœ‰CPUä¸ºæ€§èƒ½æ¨¡å¼
</span><span>cpupower -c all frequency-set -g performance
</span><span>ç¼–è¾‘ root ç”¨æˆ·çš„ crontab:
</span></code></pre>
<p>å‘½ä»¤é‡å¯åè®¾ç½®çš„ä¼šå¤±æ•ˆï¼Œä¸‹é¢æŒä¹…åŒ–è¿™ä¸ªå‘½ä»¤ï¼Œè®©å…¶å¼€æœºè‡ªåŠ¨æ‰§è¡Œ</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">sudo</span><span> crontab</span><span style="color:#ffcc66;"> -e
</span></code></pre>
<p>æ·»åŠ ä»¥ä¸‹å†…å®¹ä»¥åœ¨å¯åŠ¨æ—¶è¿è¡Œå‘½ä»¤:</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>@reboot /usr/bin/cpupower -c all frequency-set -g powersave
</span></code></pre>

      </div>
    </div>
    <div class="prompt" id="terminal"><input
    type="text"
    id="setter"
    onkeydown="writeit(this, event);moveIt(this.value.length, event)"
    onchange="writeit(this, event)"
    onkeyup="writeit(this, event)"
    onkeypress="writeit(this, event);"
    >
<label for="setter" id="writer"> </label><b class="cursor" id="cursor"></b></div>
  </main>
</body>
</html>
